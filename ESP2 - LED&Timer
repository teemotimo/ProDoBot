#include "SevSeg.h"
#include <WiFi.h>
#include "esp_eap_client.h"
#include <PubSubClient.h>
#include <ArduinoJson.h>

SevSeg sevseg;

// ============= WIFI - CHANGE THESE =============
#define WIFI_SSID "SFUNET-SECURE"
#define EAP_IDENTITY "yourname@sfu.ca"
#define EAP_PASSWORD "yourpassword"

// ============= MQTT =============
const char* mqtt_server = "broker.hivemq.com";
const int mqtt_port = 1883;

WiFiClient espClient;
PubSubClient client(espClient);

// ============= LED PINS =============
#define LED_RED   25
#define LED_GREEN 26
#define LED_BLUE  27

// ============= BUZZER =============
#define BUZZER_PIN 5

// ============= 7-SEG PINS =============
#define DIGIT1 16
#define DIGIT2 17
#define DIGIT3 18
#define DIGIT4 19

#define SEG_A 21
#define SEG_B 22
#define SEG_C 23
#define SEG_D 13
#define SEG_E 14
#define SEG_F 32
#define SEG_G 33
#define SEG_DP 4

// ============= TIMER =============
unsigned long previousMillis = 0;
int totalSeconds = 0;
bool timerRunning = false;
bool alarmTriggered = false;

// ============= LED FUNCTIONS =============
void allOff() {
  digitalWrite(LED_RED, LOW);
  digitalWrite(LED_GREEN, LOW);
  digitalWrite(LED_BLUE, LOW);
}

void setMood(const char* color) {
  allOff();
  if (strcmp(color, "warm") == 0) digitalWrite(LED_RED, HIGH);
  else if (strcmp(color, "focus") == 0) digitalWrite(LED_GREEN, HIGH);
  else if (strcmp(color, "chill") == 0) digitalWrite(LED_BLUE, HIGH);
}

// ============= WIFI =============
void setwifi() {
  WiFi.disconnect(true);
  WiFi.mode(WIFI_STA);
  esp_eap_client_set_identity((uint8_t *)EAP_IDENTITY, strlen(EAP_IDENTITY));
  esp_eap_client_set_username((uint8_t *)EAP_IDENTITY, strlen(EAP_IDENTITY));
  esp_eap_client_set_password((uint8_t *)EAP_PASSWORD, strlen(EAP_PASSWORD));
  esp_wifi_sta_enterprise_enable();
  WiFi.begin(WIFI_SSID);
  while (WiFi.status() != WL_CONNECTED) delay(500);
}

// ============= MQTT CALLBACK =============
void callback(char* topic, byte* payload, unsigned int length) {
  StaticJsonDocument<200> doc;
  deserializeJson(doc, payload, length);
  
  String t = String(topic);
  
  // Lighting
  if (t == "room/lighting") {
    const char* color = doc["color"] | "off";
    setMood(color);
  }
  
  // Timer
  if (t == "room/timer") {
    const char* action = doc["action"] | "none";
    
    if (strcmp(action, "start") == 0) {
      totalSeconds = doc["duration"] | 60;
      timerRunning = true;
      alarmTriggered = false;
    } else if (strcmp(action, "stop") == 0) {
      timerRunning = false;
      totalSeconds = 0;
    } else if (strcmp(action, "pause") == 0) {
      timerRunning = !timerRunning;
    }
  }
}

// ============= MQTT RECONNECT =============
void reconnect() {
  if (!client.connected()) {
    String clientId = "ESP32-LED-Timer-" + String(random(0xffff), HEX);
    if (client.connect(clientId.c_str())) {
      client.subscribe("room/lighting");
      client.subscribe("room/timer");
    }
  }
}

// ============= SETUP =============
void setup() {
  Serial.begin(115200);
  
  // LEDs
  pinMode(LED_RED, OUTPUT);
  pinMode(LED_GREEN, OUTPUT);
  pinMode(LED_BLUE, OUTPUT);
  allOff();
  
  // Buzzer
  pinMode(BUZZER_PIN, OUTPUT);
  
  // 7-seg display
  byte numDigits = 4;
  byte digitPins[] = {DIGIT1, DIGIT2, DIGIT3, DIGIT4};
  byte segmentPins[] = {SEG_A, SEG_B, SEG_C, SEG_D, SEG_E, SEG_F, SEG_G, SEG_DP};
  
  sevseg.begin(COMMON_CATHODE, numDigits, digitPins, segmentPins,
               false, false, true, true);
  sevseg.setBrightness(90);
  
  // WiFi & MQTT
  setwifi();
  client.setServer(mqtt_server, mqtt_port);
  client.setCallback(callback);
}

// ============= LOOP =============
void loop() {
  reconnect();
  client.loop();
  sevseg.refreshDisplay();
  
  // Timer countdown
  unsigned long now = millis();
  if (timerRunning && now - previousMillis >= 1000 && totalSeconds > 0) {
    previousMillis = now;
    totalSeconds--;
  }
  
  // Display MM:SS
  int minutes = totalSeconds / 60;
  int seconds = totalSeconds % 60;
  sevseg.setNumber(minutes * 100 + seconds);
  
  // Buzzer when done
  if (totalSeconds == 0 && timerRunning && !alarmTriggered) {
    alarmTriggered = true;
    timerRunning = false;
    tone(BUZZER_PIN, 500, 1000);
  }
}
